<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>White Box</title>
</head>
<body>
    <h1>White Box</h1>
    <h2>Treasure</h2>
    <p>A monster guards an amount of treasure equal to 1-4 times its XP value in gold pieces. Wandering monsters never carry treasure with them.</p>
    <p>Enter the monster's XP:</p>
    <label for="input-monster-xp"></label>
    <input id="input-monster-xp" type="text">
    <button id="btn-calculate-treasure">Calculate Treasure</button>
    <p id="display-treasure"></p>
    <h3>Treasure Trade Outs</h3>
    <p>In addition to coins, treasures contain gems, jewelry, and magical items. Treasures should be interesting‚Äîan endless series of ‚Äúanother treasure worth 100 gp in total‚Äù is a sure-fire recipe for boring your players.</p>
    <p>For every 5,000 gp in value, there is a 10% chance of trading out 5,000 gp for an item on either the Major Gem/Jewelry or Major Magic Item table.</p>
    
    <button id="btn-trade-out-major">Attempt to Trade out 5000 gp (1 try, 10% chance)</button>
    <br>
    <button id="btn-trade-out-medium">Attempt to Trade out 1000 gp (1 try, 10% chance)</button>
    <br>
    <button id="btn-trade-out-minor">Attempt to Trade out 100 gp (1 try, 10% chance)</button>
    
    <p id="display-trade-out"></p>
    <p id="display-trade-out2"></p>

    <script src="whitebox_treasure.js"></script>
    <script src="whitebox_spells.js"></script>
    <script src="whitebox_weapons_armor.js"></script>

    <script>

        const treasureQualities = {
            major: {quality: "Major", modifier: 12, potion_rolls: 6},
            medium: {quality: "Medium", modifier: 6, potion_rolls: 3},
            minor: {quality: "Minor", modifier: 0, potion_rolls: 1}
        };
        
        const inputMonsterXp = document.getElementById("input-monster-xp");
        const btnCalculateTreasure = document.getElementById("btn-calculate-treasure");
        const displayTreasure = document.getElementById('display-treasure');
        
        const btnTradeOutMajor = document.getElementById('btn-trade-out-major');
        const btnTradeOutMedium = document.getElementById('btn-trade-out-medium');
        const btnTradeOutMinor = document.getElementById('btn-trade-out-minor');

        const displayTradeOut = document.getElementById('display-trade-out');
        const displayTradeOut2 = document.getElementById('display-trade-out2');

        let scrollUser = "";
        let treasureType;
        let treasureQuality = "";
        let treasureQualityTableBonus = 0;
        
        /// LISTENERS
        btnCalculateTreasure.addEventListener('click', () => {
            calculateTreasure();
        });
        btnTradeOutMajor.addEventListener('click', () => {
            treasureType = treasureQualities.major;
            tradeOutTreasure();
        });

        btnTradeOutMedium.addEventListener('click', () => {
            treasureType = treasureQualities.medium;
            tradeOutTreasure();
        });

        btnTradeOutMinor.addEventListener('click', () => {
            treasureType = treasureQualities.minor;
            tradeOutTreasure();
        });


        /// HELPER FUNCTIONS

        function calculateTreasure() {
            let treasure_value = 0;
            let percentage_copper = 0;
            let percentage_silver = 0;
            let percentage_gold = 0;
            let copper_pieces = 0;
            let silver_pieces = 0;
            let gold_pieces = 0;
            let inputXp = inputMonsterXp.value;
            let inputXpAsInteger = Number(inputXp);
            let die_roll = roll1dx(6);
            
            if ( die_roll == 1 ) {
                treasure_value = inputXpAsInteger * 1;
                percentage_copper = 50;
                percentage_silver = 30;
                percentage_gold = 20;
            } else if ( die_roll == 2 || die_roll == 3 ) {
                treasure_value = inputXpAsInteger * 2;
                percentage_copper = 20;
                percentage_silver = 50;
                percentage_gold = 30;
            } else if ( die_roll == 4 || die_roll == 5 ) {
                treasure_value = inputXpAsInteger * 3;
                percentage_copper = 10;
                percentage_silver = 40;
                percentage_gold = 50;
            } else {
                treasure_value = inputXpAsInteger * 4;
                percentage_copper = 0;
                percentage_silver = 25;
                percentage_gold = 75;
            } 
            copper_pieces = get_percentage(treasure_value, percentage_copper);
            silver_pieces = get_percentage(treasure_value, percentage_silver);
            gold_pieces = get_percentage(treasure_value, percentage_gold);

            displayTreasure.innerText =
                `Teasure Value: ${treasure_value}gp. (Copper Pieces: ${copper_pieces}, Silver Pieces: ${silver_pieces}, Gold Pieces: ${gold_pieces})`;
        };

        function tradeOutTreasure() {
            // Trade out has 10% chance of success for all quality levels.
            // Check if a trade out is successful...
            let die_roll = roll1dx(100);
            
            // Trade out was successful...
            if ( die_roll <= 100 ) { // Change this to <= 10 for live!
                console.log("\nTRADE OUT SUCCESSFUL!");
                
                // Check if the trade out is for Magic Items or Gem/Jewelry...
                die_roll = roll1dx(20);
                
                if ( die_roll > 10 ) { // Change this to == for live!
                    // Trade out is for a Magic Item...
                    getMagicItem();
                    
                } else {
                    // Trade out is for a Gem or Jewelry...
                    console.log(`Roll on the '${treasureType.quality} Gem/Jewelry' table...`)
                    // Determine the QUALITY of the gem or jewelry...
                    die_roll = roll1dx(6);
                    
                    if (treasureType.quality == "Major") {
                        // I'm using compact code here because it only has multiplier formulas.
                        const base = roll1dx(100) * 10;
                        
                        const multiplier = 
                            die_roll === 1 ? 1 :
                            die_roll <= 3 ? 8 :
                            die_roll <= 5 ? 12 :
                            20;

                        die_roll = base * multiplier;
                    
                    } else if (treasureType.quality == "Medium") {
                        // I'm using readable code here because it has different formulas.
                        if ( die_roll == 1 ) {
                            die_roll = roll1dx(100);
                        } else if ( die_roll == 2 || die_roll == 3 ) {
                            die_roll = (roll1dx(100) * 10) + 250;
                        } else if ( die_roll == 4 || die_roll == 5 ) {
                            die_roll = (roll1dx(100) * 10) + 750;
                        } else {
                            die_roll = roll1dx(100) * 100;
                        }
                        
                    } else {
                        // I'm using readable code here because it has different formulas.
                        if ( die_roll == 1 ) {
                            die_roll = roll1dx(6);
                        } else if ( die_roll == 2 || die_roll == 3 ) {
                            die_roll = roll1dx(100) + 25;
                        } else if ( die_roll == 4 || die_roll == 5 ) {
                            die_roll = roll1dx(100) + 75;
                        } else {
                            die_roll = roll1dx(100) * 10;
                        }
                    }
                    console.log(`${treasureType.quality} Gem or Jewelry worth ${die_roll}gp.`);
                }
            } else {
                // Trade out was unsuccessful...
                displayTradeOut.innerText ="Trade out failed."
                console.log("TRADE OUT FAILED");
            }
        }

        function roll1dx(number_of_sides) {
            return Math.floor(Math.random() * number_of_sides) +1;
        };

        function get_percentage(num, per) {
            return (num / 100) * per;
        };

        function getListLength(listName) {
            return listName.length;
        };

        function getRandomProtectionScroll() {
            const randomProtectionScrollIndex = Math.floor(Math.random() * protectionFrom.length);
            return protectionFrom[randomProtectionScrollIndex];
        }

        
        

        // # GET MAGIC ITEM (ALL QUALITY LEVELS)
        function getMagicItem() {
            console.log("Roll on the 'Magic Item' table...")
            // Determine the type of Major Magic Item...
            die_roll = roll1dx(6); // Change this to 6 for live!
            if ( die_roll == 1 ) {
                getPotion();

            } else if ( die_roll == 2 || die_roll == 3 ) {
                getScroll();

            } else if ( die_roll == 4 || die_roll == 5 ) {
                console.log("‚öî Roll 1d6 +12 on the Weapons and Armor table")

            } else {
                console.log("Roll 1d20 +40 on the Miscellaneous table...")
            }
        };

        function getPotion() {
            let listPotions = [];
            console.log(`üç∑ Treasure Quality: ${treasureType.quality}, Treasure Type: Potion`);
            // Get the number of potion table rolls, based on the pre-defined Quality...
            let numberOfPotionRolls = treasureType.potion_rolls;

            for ( rolls = 1; rolls <= numberOfPotionRolls; rolls++ ) {
                die_roll = roll1dx(100);
                let potion = oddTreasurePotions.find(
                item => die_roll >= item.start && die_roll <= item.end
                )?.value || "No Match. Check your code!";
                listPotions.push(potion);
            }

            listPotions.forEach(potion => {
                console.log(`Potion of ${potion}`);
            });
        }

        // # GET SCROLL
        function getScroll() {
            console.log(`üìú Treasure Quality: ${treasureType.quality}, Treasure Type: Scroll`);
            scrollUser = "";
            let scroll = "";
            let spellLevel = 0;
            let listRandomSpell = [];

            die_roll = roll1dx(8) + treasureQualityTableBonus; // Roll 1d8 + Quality mod
            
            if ( die_roll == 1 ) {
                // One 1st level scroll...
                console.log("Roll 1 level-1 spell...");
                generateRandomScrolls(1, 1, 1);
            } else if ( die_roll == 2 ) {
                // One scroll of level 1d3...
                console.log("Roll 1 spell at level 1d3...");
                generateRandomScrolls(1, 1, 3);
            } else if ( die_roll == 3 ) {
                // Two scrolls of levels 1d2...
                console.log("Roll 2 spells of levels 1-2...");
                generateRandomScrolls(2, 1, 2);
            } else if ( die_roll == 4 ) {
                // Three spells at level 1
                console.log("Roll 3 spells of level 1...");
                generateRandomScrolls(3, 1, 1);
            } else if ( die_roll == 5 || die_roll == 12 || die_roll == 19) {
                console.log("üíÄ Find a Cursed Scroll üíÄ");
                return
            } else if ( die_roll == 6 || die_roll == 7 ) {
                console.log("Roll a random Protection Scroll (standard duration)...");
                letRandomScroll = getRandomProtectionScroll();
                console.log(`Protection from ${letRandomScroll}`);
            } else if ( die_roll == 8 ) {
                // Two spells of levels 1d4...
                console.log("Roll 2 spells of levels 1-4...");
                generateRandomScrolls(2, 1, 4);
            } else if (die_roll == 9) {
                // Two spells of levels 1d6
                console.log("Roll 2 spells of levels 1 to 6 (Level 1-5 if Cleric)...");
                generateRandomScrolls(2, 1, 6);
            } else if (die_roll == 10) {
                // One spell of level 1d4+2
                console.log("Roll 1 spell of level 1d4 +2...");
                generateRandomScrolls(1, 3, 6);
            } else if (die_roll == 11) {
                console.log("Roll 5 spells of levels 1d3...");
                generateRandomScrolls(5, 1, 3);
            } else if (die_roll == 13 || die_roll == 14) {
                console.log("Roll a random Protection Scroll (double duration)...");
                letRandomScroll = getRandomProtectionScroll();
                console.log(`Protection from ${letRandomScroll}`);
            } else if (die_roll == 15) {
                console.log("Roll 5 spells of levels 1-6...");
                generateRandomScrolls(5, 1, 6);
            } else if (die_roll == 16) {
                console.log("Roll 6 spells of levels 1-6...");
                generateRandomScrolls(6, 1, 6);
            } else if (die_roll == 17) {
                console.log("Roll 7 spells of levels 1-6...");
                generateRandomScrolls(7, 1, 6);
            } else if (die_roll == 18) {
                console.log("Roll 8 spells of levels 1-6...");
                generateRandomScrolls(8, 1, 6);
            } else if (die_roll == 20) {
                console.log("Roll a random Protection Scroll (triple duration & double effects)...");
                letRandomScroll = getRandomProtectionScroll();
                console.log(`Protection from ${letRandomScroll}`);
            } else {
                scroll = "No match";
            }
        };


        function generateRandomScrolls(numberOfScrolls, minLevel, maxLevel) {
            const scrolls = [];

            for (let i = 0; i < numberOfScrolls; i++) {
                // Roll spell level
                let level = Math.floor(Math.random() * (maxLevel - minLevel + 1)) + minLevel;

                // Decide scroll user (MU or Cleric)
                const user = roll1dx(2) === 1 ? "Magic User" : "Cleric";

                // Auto-correct level 6 ‚Üí 5 for Clerics
                if (user === "Cleric" && level === 6) {
                    level = 5;
                }

                // Fetch spell
                const spell = getRandomSpellByLevel(user, level);

                scrolls.push({
                    user,
                    level,
                    spell
                });
            }

            // Display results
            scrolls.forEach(s => {
                // This bit is magic! It allows me to refresh a function embedded in list.
                // typeof... asks: Is the 'duration' property a function?
                const durationValue = typeof s.spell.duration === "function"
                // if yes...
                    ? s.spell.duration()
                // if no...
                    : s.spell.duration;

                // Same logic, longer if/else version...
                /*
                let durationValue;

                    if (typeof s.spell.duration === "function") {
                        durationValue = s.spell.duration();  // call the function
                    } else {
                        durationValue = s.spell.duration;    // use the string or number
                    }
                */
                console.log(`(${s.user}) Level-${s.level}, Duration: ${durationValue}, ${s.spell.name}`);
            });
        }

        function getRandomSpellByLevel(user, level) {
            let list = [];

            if (user === "Cleric") {
                list = spellsCleric.filter(spell => spell.level === level);
            } else {
                list = spellsMage.filter(spell => spell.level === level);
            }

            if (list.length === 0) {
                return { name: "No spell found", level };
            }

            const randomIndex = Math.floor(Math.random() * list.length);
            return list[randomIndex];
        }


    </script>
</body>
</html>
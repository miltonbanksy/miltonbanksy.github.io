<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>White Box</title>
    <style>
        html {
            padding: 10px;
        }

        .btn-trade-out {
            width: 200px;
        }
        .label-developer {
            display: inline-block;
            width: 130px;
        }
    </style>
</head>
<body>
    <h1>White Box</h1>
    <h2>Treasure</h2>
    <p>A monster guards an amount of treasure equal to 1-4 times its XP value in gold pieces. Wandering monsters never carry treasure with them.</p>
    <p>Enter the monster's XP:</p>
    <label for="input-monster-xp"></label>
    <input id="input-monster-xp" type="text">
    <button id="btn-calculate-treasure">Calculate Treasure</button>
    <p id="display-treasure"></p>
    
    <h3>Treasure Trade Outs</h3>
    <p>In addition to coins, treasures contain gems, jewelry, and magical items.</p>
    <p>There is a 10% chance of trading out coins for a 'Minor', 'Medium', or 'Major' item on either the Gem/Jewelry or Magic Item table.</p>
    <p>If the trade-out is successfull, there is a 5% chance of obtaining a Magic item.</p>
    
    <button class="btn-trade-out" id="btn-trade-out-major">Trade Out 5000 gp (Major Item)</button>
    <br>
    <button class="btn-trade-out" id="btn-trade-out-medium">Trade Out 1000 gp (Medium Item)</button>
    <br>
    <button class="btn-trade-out" id="btn-trade-out-minor">Trade Out 100 gp (Minor Item)</button>
    
    <p id="display-trade-out"></p>
    <p class="treasure-displays" id="display-trade-out-magic-or-mundane"></p>
    <p class="treasure-displays" id="display-treasure-quality"></p>
    <p class="treasure-displays" id="display-treasure-category"></p>
    <p class="treasure-displays" id="display-treasure-name"></p>
    <p class="treasure-displays" id="display-treasure-description"></p>

    <br>
    <hr>

    <h3>Referee Tweaks / Developer Testing</h3>

    <label class="label-developer" for="input-set-trade-out-chance">Chance of Trade Out (%)</label>
    <input id="input-set-trade-out-chance" type="number" placeholder="Default is 10%">
    <button id="btn-set-trade-out-chance">Set</button>
    <label id="display-trade-out-chance">10%</label>
    
    <br><br>
    
    <label class="label-developer" for="input-set-magic-item-chance">Chance of Magic Item (%)</label>
    <input id="input-set-magic-item-chance" type="number" placeholder="Default is 5% (1/20)">
    <button id="btn-set-magic-item-chance">Set</button>
    <label id="display-magic-item-chance">5%</label>


    <script src="whitebox_potions_logic.js"></script>
    <script src="whitebox_spells.js"></script>
    <script src="whitebox_weapons_armor.js"></script>
    <script src="whitebox_weapons_armor_logic.js"></script>
    <script src="whitebox_miscMagicItems.js"></script>

    <script>

        const treasureQualities = {
            major: {quality: "Major", modifier: 12, miscModifier: 40, potion_rolls: 6},
            medium: {quality: "Medium", modifier: 6, miscModifier: 20, potion_rolls: 3},
            minor: {quality: "Minor", modifier: 0, miscModifier: 0, potion_rolls: 1}
        };
        
        const inputMonsterXp = document.getElementById("input-monster-xp");
        const btnCalculateTreasure = document.getElementById("btn-calculate-treasure");
        const displayTreasure = document.getElementById('display-treasure');
        
        const btnTradeOutMajor = document.getElementById('btn-trade-out-major');
        const btnTradeOutMedium = document.getElementById('btn-trade-out-medium');
        const btnTradeOutMinor = document.getElementById('btn-trade-out-minor');

        const displayTradeOut = document.getElementById('display-trade-out');
        const displayTradeOutMagicOrMundane = document.getElementById('display-trade-out-magic-or-mundane');

        const displayTreasureCategory = document.getElementById('display-treasure-category');

        const displayTreasureQuality = document.getElementById('display-treasure-quality');
        const displayTreasureName = document.getElementById('display-treasure-name');
        const displayTreasureDescription = document.getElementById('display-treasure-description');

        // Group the displays:
        const treasureDisplays = document.getElementsByClassName('treasure-displays');

        // GM Developer Tools
        const inputSetTradeOutChance = document.getElementById('input-set-trade-out-chance');
        const btnSetTradeOutChance = document.getElementById('btn-set-trade-out-chance');
        const displayTradeOutChance = document.getElementById('display-trade-out-chance');
        const inputSetMagicItemChance = document.getElementById('input-set-magic-item-chance');
        const btnSetMagicItemChance = document.getElementById('btn-set-magic-item-chance');
        const displayMagicItemChance = document.getElementById('display-magic-item-chance');

        let chanceOfTradeOut = 10; // DEFAULT 10
        let chanceOfTradeOutAsInt = 10; // DEFAULT 1/10 10%
        let chanceOfMagicItem = 5; // DEFAULT 1/20, 5%
        let chanceOfMagicItemAsInt = 5; // DEFAULT 1/20, 5%

        let scrollUser = "";
        let treasureType = "";
        let treasureCategory = "";
        let treasureQuality = "";
        let treasureQualityTableBonus = 0;
        let magicalOrMundaneItem = "";
        
        /// LISTENERS
        btnCalculateTreasure.addEventListener('click', () => {
            calculateTreasure();
        });

        btnTradeOutMajor.addEventListener('click', () => {
            treasureType = treasureQualities.major;
            tradeOutTreasure();
        });

        btnTradeOutMedium.addEventListener('click', () => {
            treasureType = treasureQualities.medium;
            tradeOutTreasure();
        });

        btnTradeOutMinor.addEventListener('click', () => {
            treasureType = treasureQualities.minor;
            tradeOutTreasure();
        });

        // GM / DEVELOPER LISTENERS
        btnSetTradeOutChance.addEventListener('click', () => {
            chanceOfTradeOut = inputSetTradeOutChance.value;
            chanceOfTradeOutAsInt = Number(chanceOfTradeOut);
            displayTradeOutChance.innerHTML = chanceOfTradeOutAsInt + "%";
        });

        btnSetMagicItemChance.addEventListener('click', () => {
            chanceOfMagicItem = inputSetMagicItemChance.value;
            chanceOfMagicItemAsInt = Number(chanceOfMagicItem);
            displayMagicItemChance.innerHTML = chanceOfMagicItemAsInt + "%";
        });


        /// HELPER FUNCTIONS

        function calculateTreasure() {
            
            let treasure_value = 0;
            let percentage_copper = 0;
            let percentage_silver = 0;
            let percentage_gold = 0;
            let copper_pieces = 0;
            let silver_pieces = 0;
            let gold_pieces = 0;
            let inputXp = inputMonsterXp.value;
            let inputXpAsInteger = Number(inputXp);
            let die_roll = roll1dx(6);
            
            if ( die_roll == 1 ) {
                treasure_value = inputXpAsInteger * 1;
                percentage_copper = 50;
                percentage_silver = 30;
                percentage_gold = 20;
            } else if ( die_roll == 2 || die_roll == 3 ) {
                treasure_value = inputXpAsInteger * 2;
                percentage_copper = 20;
                percentage_silver = 50;
                percentage_gold = 30;
            } else if ( die_roll == 4 || die_roll == 5 ) {
                treasure_value = inputXpAsInteger * 3;
                percentage_copper = 10;
                percentage_silver = 40;
                percentage_gold = 50;
            } else {
                treasure_value = inputXpAsInteger * 4;
                percentage_copper = 0;
                percentage_silver = 25;
                percentage_gold = 75;
            } 
            copper_pieces = get_percentage(treasure_value, percentage_copper);
            silver_pieces = get_percentage(treasure_value, percentage_silver);
            gold_pieces = get_percentage(treasure_value, percentage_gold);

            displayTreasure.innerText =
                `Teasure Value: ${treasure_value}gp. (Copper Pieces: ${copper_pieces}, Silver Pieces: ${silver_pieces}, Gold Pieces: ${gold_pieces})`;
        };

        function tradeOutTreasure() {
            
            // Clear the treasure detail displays:
            for (let i = 0; i < treasureDisplays.length; i++) {
                treasureDisplays[i].innerHTML = "";
            }
            
            // Trade out has 10% chance of success for all quality levels.
            // Check if a trade out is successful...
            
            displayTradeOutMagicOrMundane.innerHTML = "";
            let die_roll = roll1dx(100);
            
            // Trade out was successful...
            if ( die_roll <= chanceOfTradeOutAsInt ) { // Defaults to 10. User can change this.
                displayTradeOut.innerHTML ="\nTrade out successful";
                
                // Check if the trade out is for Magic Items or Gem/Jewelry...
                die_roll = roll1dx(100);
                
                if ( die_roll <= chanceOfMagicItemAsInt ) { // Defaults to 1/20, 5%
                    magicalOrMundaneItem = "magical item";
                    displayTradeOutMagicOrMundane.innerHTML = "Magical Item(s)"
                    getMagicItem();
                    
                } else {
                    magicalOrMundaneItem = "Non-Magical Item";
                    displayTradeOutMagicOrMundane.innerHTML = "Non-Magical Item(s)";
                    
                    // Determine the QUALITY of the gem or jewelry...
                    die_roll = roll1dx(6);
                    
                    if (treasureType.quality == "Major") {
                        // I'm using compact code here because it only has multiplier formulas.
                        const base = roll1dx(100) * 10;
                        
                        const multiplier = 
                            die_roll === 1 ? 1 :
                            die_roll <= 3 ? 8 :
                            die_roll <= 5 ? 12 :
                            20;

                        die_roll = base * multiplier;
                    
                    } else if (treasureType.quality == "Medium") {
                        // I'm using readable code here because it has different formulas.
                        if ( die_roll == 1 ) {
                            die_roll = roll1dx(100);
                        } else if ( die_roll == 2 || die_roll == 3 ) {
                            die_roll = (roll1dx(100) * 10) + 250;
                        } else if ( die_roll == 4 || die_roll == 5 ) {
                            die_roll = (roll1dx(100) * 10) + 750;
                        } else {
                            die_roll = roll1dx(100) * 100;
                        }
                        
                    } else {
                        // I'm using readable code here because it has different formulas.
                        if ( die_roll == 1 ) {
                            die_roll = roll1dx(6);
                        } else if ( die_roll == 2 || die_roll == 3 ) {
                            die_roll = roll1dx(100) + 25;
                        } else if ( die_roll == 4 || die_roll == 5 ) {
                            die_roll = roll1dx(100) + 75;
                        } else {
                            die_roll = roll1dx(100) * 10;
                        }
                    }
                    displayTreasureQuality.innerHTML = `<h4>ðŸ’Ž ${treasureType.quality} gem or jewelry worth ${die_roll}gp</h4>`;
                }
            } else {
                // Trade out was unsuccessful...
                displayTradeOut.innerText ="Trade out failed."
            }
        }

        function roll1dx(number_of_sides) {
            return Math.floor(Math.random() * number_of_sides) +1;
        };

        function get_percentage(num, per) {
            return (num / 100) * per;
        };

        function getListLength(listName) {
            return listName.length;
        };

        function getRandomProtectionScroll() {
            const randomProtectionScrollIndex = Math.floor(Math.random() * protectionFrom2.length);
            return protectionFrom2[randomProtectionScrollIndex];
        };

        
        

        // # GET MAGIC ITEM (ALL QUALITY LEVELS)
        function getMagicItem() {
            // console.log("Roll on the 'Magic Item' table...")
            // Determine the type of Major Magic Item...
            die_roll = roll1dx(6); // Change this to 6 for live!
            // die_roll = 4 // !!!! TESTING ONLY !!!!
            if ( die_roll == 1 ) {
                getPotion();

            } else if ( die_roll == 2 || die_roll == 3 ) {
                getScroll();

            } else if ( die_roll == 4 || die_roll == 5 ) {
                getWeaponArmor();

            } else {
                getMiscItem();
            }
        };

        

        

        

        // # GET SCROLL
        function getScroll() {
            
            treasureQuality = "<h3>ðŸ“œ Scroll(s)<h3";
            displayTreasureQuality.innerHTML = treasureQuality;
            scrollUser = "";
            let scroll = "";
            let spellLevel = 0;
            let randomProtectionScroll = "";
            let listRandomSpell = [];

            die_roll = roll1dx(8) + treasureType.modifier; // Roll 1d8 + Quality mod
            // die_roll = 6; // !!!! TEST ONLY REMOVE !!!!
            
            // Info: generateRandomScrolls(number of scrolls, min level, max level)
            if ( die_roll == 1 ) {
                generateRandomScrolls(1, 1, 1);
            } else if ( die_roll == 2 ) {
                generateRandomScrolls(1, 1, 3);
            } else if ( die_roll == 3 ) {
                generateRandomScrolls(2, 1, 2);
            } else if ( die_roll == 4 ) {
                generateRandomScrolls(3, 1, 1);
            } else if ( die_roll == 5 || die_roll == 12 || die_roll == 19) {
                displayTreasureName.innerHTML = "ðŸ’€ Cursed Scroll ðŸ’€";
                //console.log("ðŸ’€ Find a Cursed Scroll ðŸ’€");
                return
            } else if ( die_roll == 6 || die_roll == 7 ) {
                randomProtectionScroll = getRandomProtectionScroll();
                displayTreasureName.innerHTML = `<b>Protection from ${randomProtectionScroll.type}</b> (Standard duration)`;
                displayTreasureDescription.innerHTML = randomProtectionScroll.description;
            } else if ( die_roll == 8 ) {
                generateRandomScrolls(2, 1, 4);
            } else if (die_roll == 9) {
                generateRandomScrolls(2, 1, 6);
            } else if (die_roll == 10) {
                generateRandomScrolls(1, 3, 6);
            } else if (die_roll == 11) {
                generateRandomScrolls(5, 1, 3);
            } else if (die_roll == 13 || die_roll == 14) {
                randomProtectionScroll = getRandomProtectionScroll();
                displayTreasureName.innerHTML = `<b>Protection from ${randomProtectionScroll.type}</b> (Double duration)`;
                displayTreasureDescription.innerHTML = randomProtectionScroll.description;
            } else if (die_roll == 15) {
                generateRandomScrolls(5, 1, 6);
            } else if (die_roll == 16) {
                generateRandomScrolls(6, 1, 6);
            } else if (die_roll == 17) {
                generateRandomScrolls(7, 1, 6);
            } else if (die_roll == 18) {
                generateRandomScrolls(8, 1, 6);
            } else if (die_roll == 20) {
                crandomProtectionScroll = getRandomProtectionScroll();
                displayTreasureName.innerHTML = `<b>Protection from ${randomProtectionScroll.type}</b> (Triple duration, Double effect)`;
                displayTreasureDescription.innerHTML = randomProtectionScroll.description;
            } else {
                scroll = "No match";
            }
        };


        function generateRandomScrolls(numberOfScrolls, minLevel, maxLevel) {
            const scrolls = [];

            for (let i = 0; i < numberOfScrolls; i++) {
                // Roll spell level
                let level = Math.floor(Math.random() * (maxLevel - minLevel + 1)) + minLevel;

                // Decide scroll user (MU or Cleric)
                const user = roll1dx(2) === 1 ? "Magic User" : "Cleric";

                // Auto-correct level 6 â†’ 5 for Clerics
                if (user === "Cleric" && level === 6) {
                    level = 5;
                }

                // Fetch spell
                const spell = getRandomSpellByLevel(user, level);

                scrolls.push({
                    user,
                    level,
                    spell
                });
            }

            // Display results
            scrolls.forEach(s => {
                // This bit is magic! It allows me to refresh a function embedded in list.
                // typeof... asks: Is the 'duration' property a function?
                const durationValue = typeof s.spell.duration === "function"
                // if yes...
                    ? s.spell.duration()
                // if no...
                    : s.spell.duration;

                // Same logic, longer if/else version...
                /*
                let durationValue;

                    if (typeof s.spell.duration === "function") {
                        durationValue = s.spell.duration();  // call the function
                    } else {
                        durationValue = s.spell.duration;    // use the string or number
                    }
                */

                const heading4Element = document.createElement('div');
                const linebreakElement = document.createElement('br');
                
                heading4Element.innerHTML = `<b>${s.spell.name}</b> (Level ${s.spell.level} ${s.user} spell)<br>${s.spell.description}`;
                displayTreasureDescription.appendChild(heading4Element);
                displayTreasureDescription.appendChild(linebreakElement);
            });
        }

        function getRandomSpellByLevel(user, level) {
            let list = [];

            if (user === "Cleric") {
                list = spellsCleric.filter(spell => spell.level === level);
            } else {
                list = spellsMage.filter(spell => spell.level === level);
            }

            if (list.length === 0) {
                return { name: "No spell found", level };
            }

            const randomIndex = Math.floor(Math.random() * list.length);
            return list[randomIndex];
        }


    </script>
</body>
</html>